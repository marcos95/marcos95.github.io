{"version":3,"sources":["webpack:///src/app/core/services/deposit/deposit.service.ts","webpack:///src/app/deposit/components/imposition-item/imposition-item.component.html","webpack:///src/app/deposit/components/imposition-item/imposition-item.component.ts","webpack:///src/app/deposit/deposit.component.html","webpack:///src/app/deposit/deposit.component.ts","webpack:///src/app/deposit/services/imposition.service.ts","webpack:///src/app/deposit/utils/imposition.validators.ts","webpack:///src/app/core/constants/external-documents.constants.ts","webpack:///src/app/deposit/components/new-imposition-form/new-imposition-form.component.html","webpack:///src/app/deposit/components/new-imposition-form/new-imposition-form.component.ts","webpack:///src/app/deposit/pages/new-imposition/new-imposition.component.html","webpack:///src/app/deposit/pages/new-imposition/new-imposition.component.ts","webpack:///node_modules/rxjs/_esm2015/internal/operators/retryWhen.js","webpack:///src/app/core/services/hire-deposit/hire-deposit.service.ts","webpack:///src/app/deposit/components/hire-deposit-status-bar/hire-deposit-status-bar.component.ts","webpack:///src/app/deposit/components/hire-deposit-status-bar/hire-deposit-status-bar.component.html","webpack:///src/app/deposit/components/hire-deposit-form/hire-deposit-form.component.html","webpack:///src/app/deposit/components/hire-deposit-form/hire-deposit-form.component.ts","webpack:///src/app/deposit/pages/hire-deposit/hire-deposit.component.html","webpack:///src/app/deposit/pages/hire-deposit/hire-deposit.component.ts","webpack:///src/app/deposit/pages/success-refund/success-refund.component.html","webpack:///src/app/deposit/pages/first-imposition/first-imposition.component.html","webpack:///src/app/deposit/pages/hire-deposit-success/hire-deposit-success.component.ts","webpack:///src/app/deposit/pages/first-imposition/first-imposition.component.ts","webpack:///src/app/deposit/pages/success-new-imposition/success-new-imposition.component.ts","webpack:///src/app/deposit/pages/success-refund/success-refund.component.ts","webpack:///src/app/deposit/deposit-routing.module.ts","webpack:///src/app/deposit/pages/success-new-imposition/success-new-imposition.component.html","webpack:///src/app/deposit/pages/hire-deposit-success/hire-deposit-success.component.html","webpack:///src/app/deposit/deposit.module.ts"],"names":["DepositService","http","errorHandlerService","agreement","url","environment","apiBasePath","endpoints","deposit","getImpositions","params","acuerdo","toString","estadoImposicion","codigoEntidad","subacuerdo","this","get","pipe","map","result","data","EE_O_ConsultaImposicionesBE","Respuesta","ListaImposicionesCliente","catchError","error","errorCode","IMP_NOT_FOUND","of","redirectErrorPage","imposition","post","createImposition","refund","createImpositionOTP","refundOTP","subagreement","getPdfImposition","response","strMessage","getRequiredDoc","showReceipt","ImpositionItemComponent","askRefundImposition","waitToRefundImposition","showDetails","moment","isSame","fechaValor","emit","expirationDate","fechaVencimiento","isEmployee","clientType","Employee","isSameOrAfter","descripcionEstadoImposicion","Activo","toggleDetails","DepositComponent","ImpositionService","depositService","headerService","globalPositionService","modalService","errorHandler","router","activatedRoute","caseService","accountService","banners","state$","createStateStream","invalidRefundOtpCode","subs","Subscription","updateTitle","fetchGlobalPosition","unsubscribe","closeModal","ref","getModalsCount","modalRef","show","hide","impositions","activeImpositionsCount","filter","length","openModal","confirmCancelDepositModal","invalidCancelationModal","accept","cancelDeposit","selectedImposition","confirmRefundModal","fileName","Acuerdo","add","subscribe","blob","a","document","createElement","href","URL","createObjectURL","download","click","showError","depositAgreement","generateRefundOtp","refundOtpId","generateRefundImpositionOTP","impositionAgreement","nominalAmount","String","parseFloat","importeNominal","otpId","refundOtpModal","secretKey","refundImposition","otp","navigate","queryParams","skipLocationChange","relativeTo","item","date","expirationDates","it","recentExpirationDate","body","type","TOTAL_CANCELLATION_OF_THE_TERM_DEPOSIT","recordTypeDeveloperName","CANCELLATIONS","description","subject","newIBAN","IBAN","createCase","caseList","successCancelDepositModal","globalPosition$","globalPosition","combineLatest","tap","createImpositionsStream","currentCustomer$","account","currentCustomer","switchMap","dictionaryService","createState","impositionConditions$","getImpositionConditions","onSuccess","onError","referenceOTP","state","generateCreateImpositionOTP","zip","amountValidator","formGroup","impositionConditionInput","amountInput","impositionCondition","value","amount","maximum","maxImposition","minimum","minImposition","documents","applications","employeeDocuments","impositionConditions","particularConditions","notEmployeeDocuments","EXTERNAL_DOCUMENTS","providedIn","factory","DatosPersonales","makeImposition","NewImpositionFormComponent","fb","externalDocuments","submitted","showConfirm","conditionsRead","createForm","form","markAllAsTouched","valid","duration","frecuency","settFrequency","control","touched","invalid","window","open","balance","group","required","Balance","balanceError","conditions","requiredTrue","validators","hasError","NewImpositionComponent","route","impositionService","invalidImpositionOtpCode","destroy","initImposition","generateOtp","otpModal","navigateToSuccessPage","retryWhen","notifier","source","lift","RetryWhenOperator","HireDepositService","HireDepositStatusBarComponent","subscriber","destination","super","err","isStopped","errors","retries","retriesSubscription","Subject","e","subscribeToResult","_unsubscribeAndRecycle","next","outerValue","innerValue","outerIndex","innerIndex","innerSub","_unsubscribe","OuterSubscriber","productid","newHiring","getPdfContract","sign","startSignProcessSubmit","code","ERROR_SUBMIT","message","uniqueId","startSignProcessBulkSign","ERROR_BULKSIGN","ERROR_BULKSIGN_REQUESTNEWSUBMIT","querySignProcess","step","completed","active","partial","HireDepositFormComponent","formBuilder","hireDeposit","readPdf","onSubmit","readParticularConditions","HireDepositComponent","hireDepositService","loadingService","isWorking","checkPendingHiring","hiringProcess","availablePodructId","idQueryParam","snapshot","id","getProductId","productId","pendingHirings","res","RCI_Product__r","ProductCode","toPromise","getProducts","pluck","switchMapTo","signDeposit","finalize","handleSignResponse","location","console","productList","mergeMap","delay","src","KO_RETRY","throwError","HireDepositSuccessComponent","FirstImpositionComponent","SuccessNewImpositionComponent","SuccessRefundComponent","DepositRoutingModule","routes","path","component","imposition$","createImpositionStream","isNaN","isPendingSignResponse","canMakeFirstImposition","mapInProgressClient","forChild","DepositModule"],"mappings":"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","file":"x","sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { environment } from '@environment/environment';\r\nimport {\r\n  Imposition,\r\n  ImpositionOutput,\r\n  Refund,\r\n  RefundOutput,\r\n  OtpOutput,\r\n  ListaImposicionesCliente,\r\n  SalesforceResponse,\r\n  ApiError,\r\n} from '@api/models';\r\nimport { map, catchError } from 'rxjs/operators';\r\nimport { ErrorHandlerService } from '../errors/error-handler.service';\r\nimport { of } from 'rxjs';\r\nimport { ApiErrors } from '@api/constants';\r\n\r\n@Injectable({\r\n  providedIn: 'root',\r\n})\r\nexport class DepositService {\r\n  constructor(private http: HttpClient, private errorHandlerService: ErrorHandlerService) {}\r\n\r\n  getImpositions(agreement: string) {\r\n    const url = `${environment.apiBasePath}${environment.endpoints.deposit.getImpositions}`;\r\n    const params = {\r\n      acuerdo: (+agreement).toString(),\r\n      estadoImposicion: 'TODAS',\r\n      codigoEntidad: '1508',\r\n      subacuerdo: '0',\r\n    };\r\n\r\n    return this.http\r\n      .get<SalesforceResponse<any>>(url, { params })\r\n      .pipe(\r\n        map(\r\n          (result) =>\r\n            result?.data[0]?.EE_O_ConsultaImposicionesBE?.Respuesta\r\n              ?.ListaImposicionesCliente as ListaImposicionesCliente[]\r\n        ),\r\n        catchError((error: ApiError) => {\r\n          if (error.errorCode === ApiErrors.IMP_NOT_FOUND) {\r\n            return of([] as ListaImposicionesCliente[]);\r\n          }\r\n\r\n          return this.errorHandlerService.redirectErrorPage(error);\r\n        })\r\n      );\r\n  }\r\n\r\n  createImposition(imposition: Imposition) {\r\n    const url = `${environment.apiBasePath}${environment.endpoints.deposit.createImposition}`;\r\n    return this.http.post<ImpositionOutput>(url, imposition);\r\n  }\r\n\r\n  refundImposition(refund: Refund) {\r\n    const url = `${environment.apiBasePath}${environment.endpoints.deposit.refund}`;\r\n    return this.http.post<RefundOutput>(url, refund);\r\n  }\r\n\r\n  generateCreateImpositionOTP(imposition: Imposition) {\r\n    const url = `${environment.apiBasePath}${environment.endpoints.deposit.createImpositionOTP}`;\r\n    return this.http.post<OtpOutput>(url, imposition);\r\n  }\r\n\r\n  generateRefundImpositionOTP(refund: Refund) {\r\n    const url = `${environment.apiBasePath}${environment.endpoints.deposit.refundOTP}`;\r\n    return this.http.post<OtpOutput>(url, refund);\r\n  }\r\n\r\n  getPdfImposition(agreement: string, subagreement: string) {\r\n    const params = { acuerdo: agreement, subacuerdo: subagreement };\r\n    const url = `${environment.apiBasePath}${environment.endpoints.deposit.getPdfImposition}`;\r\n    return this.http\r\n      .get<SalesforceResponse<{ strMessage: string }>>(url, { params })\r\n      .pipe(map((response) => response.data?.[0]?.strMessage));\r\n  }\r\n\r\n  getRequiredDoc() {\r\n    const url = `${environment.apiBasePath}${environment.endpoints.deposit.getRequiredDoc}`;\r\n    return this.http.get<any>(url);\r\n  }\r\n}\r\n","<div\r\n  class=\"table__body__row\"\r\n  [ngClass]=\"isActive ? 'active' : 'inactive'\"\r\n  (click)=\"toggleDetails()\"\r\n>\r\n  <div class=\"table__body__title\">\r\n    <div class=\"table__body__title__group\">\r\n      <p class=\"table__body__title__group__col\">\r\n        {{ imposition?.fechaValor | date: 'dd/MM/yyyy' }}\r\n      </p>\r\n    </div>\r\n    <div class=\"table__body__title__group\">\r\n      <p class=\"table__body__title__group__col\">\r\n        {{\r\n          'deposit_imposition_detail_status_' + imposition?.descripcionEstadoImposicion\r\n            | lowercase\r\n            | translate\r\n        }}\r\n      </p>\r\n      <p class=\"table__body__title__group__col\">\r\n        {{ 'deposit_imposition_detail_term_web' | translate: { term: imposition?.duracion || 0 } }}\r\n      </p>\r\n    </div>\r\n    <div class=\"table__body__title__group\">\r\n      <p class=\"table__body__title__group__col\">\r\n        {{ imposition?.importeNominal | currency }}\r\n      </p>\r\n    </div>\r\n  </div>\r\n  <div class=\"table__body__detail\" *ngIf=\"showDetails\">\r\n    <!-- Acuerdo -->\r\n    <div class=\"table__body__detail__row\" *ngIf=\"imposition?.subacuerdo\">\r\n      <p>{{ 'deposit_imposition_detail_number' | translate }}</p>\r\n      <p>{{ imposition?.subacuerdo }}</p>\r\n    </div>\r\n\r\n    <!-- Fecha vencimiento -->\r\n    <div class=\"table__body__detail__row\" *ngIf=\"imposition?.fechaVencimiento\">\r\n      <p>{{ 'deposit_imposition_detail_expiration' | translate }}</p>\r\n      <p>{{ imposition?.fechaVencimiento | date: 'dd/MM/yyyy' }}</p>\r\n    </div>\r\n\r\n    <!-- Interes -->\r\n    <div class=\"table__body__detail__row\" *ngIf=\"imposition?.tin\">\r\n      <p>{{ 'deposit_imposition_detail_interest' | translate }}</p>\r\n      <p>{{ imposition?.tin | number: '1.2-4' }} %</p>\r\n    </div>\r\n\r\n    <!-- Fecha liquidaciÃ³n -->\r\n    <div class=\"table__body__detail__row\" *ngIf=\"imposition?.fechaProximaLiquidacion\">\r\n      <p>{{ 'deposit_imposition_detail_liquidation' | translate }}</p>\r\n      <p>{{ imposition?.fechaProximaLiquidacion | date: 'dd/MM/yyyy' }}</p>\r\n    </div>\r\n\r\n    <div class=\"table__body__detail__row\">\r\n      <button (click)=\"refundImposition()\" *ngIf=\"isActive && canRefundImposition\">\r\n        {{ 'deposit_cancel_imposition_button' | translate }}\r\n      </button>\r\n\r\n      <button (click)=\"showReceipt.emit(imposition)\" *ngIf=\"isActive\">\r\n        {{ 'deposit_show_imposition_receipt_button' | translate }}\r\n      </button>\r\n    </div>\r\n  </div>\r\n</div>\r\n","import { Component, Input, ChangeDetectionStrategy, Output, EventEmitter } from '@angular/core';\r\nimport { ListaImposicionesCliente } from '@api/models';\r\nimport { ImpositionStatus } from '@core/constants';\r\nimport * as moment from 'moment';\r\nimport { ClientType } from '@core/constants/client-type.constants';\r\n\r\n@Component({\r\n  selector: 'app-imposition-item',\r\n  templateUrl: './imposition-item.component.html',\r\n  styles: [''],\r\n  changeDetection: ChangeDetectionStrategy.OnPush,\r\n})\r\nexport class ImpositionItemComponent {\r\n  @Input() imposition: ListaImposicionesCliente;\r\n  @Input() clientType: ClientType;\r\n  @Output() askRefundImposition = new EventEmitter<ListaImposicionesCliente>();\r\n  @Output() waitToRefundImposition = new EventEmitter<void>();\r\n  @Output() showReceipt = new EventEmitter<ListaImposicionesCliente>();\r\n  showDetails = false;\r\n\r\n  constructor() {}\r\n\r\n  toggleDetails() {\r\n    this.showDetails = !this.showDetails;\r\n  }\r\n\r\n  refundImposition() {\r\n    if (moment().isSame(moment(this.imposition.fechaValor), 'day')) {\r\n      this.waitToRefundImposition.emit();\r\n    } else {\r\n      this.askRefundImposition.emit(this.imposition);\r\n    }\r\n  }\r\n\r\n  get canRefundImposition() {\r\n    const expirationDate = moment(this.imposition.fechaVencimiento);\r\n    const isEmployee = this.clientType === ClientType.Employee;\r\n\r\n    return isEmployee || (!isEmployee && moment().isSameOrAfter(expirationDate));\r\n  }\r\n\r\n  get isActive() {\r\n    return this.imposition?.descripcionEstadoImposicion === ImpositionStatus.Activo;\r\n  }\r\n}\r\n","<ng-container *ngIf=\"state$ | async as state\">\r\n  <div class=\"max-size deposit\">\r\n    <div class=\"main\">\r\n      <div class=\"main-col\" *ngIf=\"state.globalPosition\">\r\n        <div class=\"main__header\">\r\n          <div class=\"main__header__desktop\">\r\n            <div class=\"main__header__title\">\r\n              <div class=\"main__header__title__col\">\r\n                <h1>{{ 'deposit_title' | translate }}</h1>\r\n                <p>{{ state.deposit?.IBAN | formatIban }}</p>\r\n              </div>\r\n              <div class=\"main__header__title__col\">\r\n                <p>{{ 'deposit_balance' | translate }}</p>\r\n                <h1>{{ state.deposit?.Balance | currency }}</h1>\r\n              </div>\r\n            </div>\r\n            <div class=\"main__header__buttons\">\r\n              <button type=\"button\" class=\"btn--primary-small\" routerLink=\"./new-imposition\">\r\n                {{ 'deposit_new_imposition_title' | translate }}\r\n              </button>\r\n              <button\r\n                type=\"button\"\r\n                class=\"btn--terciary-small\"\r\n                *ngIf=\"\r\n                  canShowCancelDeposit(\r\n                    state?.impositions,\r\n                    state?.currentCustomer?.DatosPersonales?.clientType\r\n                  )\r\n                \"\r\n                (click)=\"askCancelDeposit(state?.impositions)\"\r\n              >\r\n                {{ 'deposit_cancel_deposit' | translate }}\r\n              </button>\r\n            </div>\r\n          </div>\r\n          <div class=\"main__header__mobile\">\r\n            <div class=\"main__header__mobile__col\">\r\n              <h1>{{ state.deposit?.Balance | currency }}</h1>\r\n              <a href=\"javascript:;\" routerLink=\"../../transactions\">{{\r\n                'deposit_go_to_asociated_account' | translate\r\n              }}</a>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div class=\"main__body\">\r\n          <div class=\"table\">\r\n            <div class=\"table__header\">\r\n              <p>{{ 'deposit_imposition_date' | translate }}</p>\r\n              <p>{{ 'deposit_imposition_description' | translate }}</p>\r\n              <p>{{ 'deposit_imposition_term' | translate }}</p>\r\n              <p>{{ 'deposit_imposition_amount' | translate }}</p>\r\n            </div>\r\n            <div class=\"table__body\" *ngIf=\"!emptyImpositions(state.impositions)\">\r\n              <div\r\n                class=\"table__body__section\"\r\n                *ngFor=\"\r\n                  let impositionGroup of state.impositions\r\n                    | groupBy: 'fechaValor'\r\n                    | keyvalue\r\n                    | sortBy: 'desc':'key';\r\n                  trackBy: trackByDates\r\n                \"\r\n              >\r\n                <p class=\"table__body__section__date\">\r\n                  {{ impositionGroup.key | date: 'dd/MM/yyyy' }}\r\n                </p>\r\n                <app-imposition-item\r\n                  *ngFor=\"let imposition of impositionGroup.value\"\r\n                  [imposition]=\"imposition\"\r\n                  [clientType]=\"state?.currentCustomer?.DatosPersonales?.clientType\"\r\n                  (askRefundImposition)=\"askRefundImposition($event)\"\r\n                  (waitToRefundImposition)=\"openModal(waitToRefundModal)\"\r\n                  (showReceipt)=\"onShowReceipt(state?.deposit, $event)\"\r\n                ></app-imposition-item>\r\n              </div>\r\n            </div>\r\n\r\n            <div class=\"table__body\" *ngIf=\"emptyImpositions(state.impositions)\">\r\n              <div class=\"table__body__title\">\r\n                <p class=\"table__body__title__group__col\">\r\n                  {{ 'deposit_empty_impositions_list_message' | translate }}\r\n                </p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      <div class=\"aside-col\" [appBannerBackground]=\"banners.deposit\">\r\n        <app-aside-banner [globalPosition]=\"state.globalPosition\"></app-aside-banner>\r\n      </div>\r\n    </div>\r\n  </div>\r\n  <div class=\"main__button group-button\">\r\n    <button\r\n      type=\"button\"\r\n      class=\"btn--secondary\"\r\n      *ngIf=\"\r\n        canShowCancelDeposit(\r\n          state?.impositions,\r\n          state?.currentCustomer?.DatosPersonales?.clientType\r\n        )\r\n      \"\r\n      (click)=\"askCancelDeposit(state?.impositions)\"\r\n    >\r\n      {{ 'deposit_cancel_deposit' | translate }}\r\n    </button>\r\n    <button type=\"button\" class=\"btn--primary\" routerLink=\"./new-imposition\">\r\n      {{ 'deposit_new_imposition_title' | translate }}\r\n    </button>\r\n  </div>\r\n\r\n  <!-- Modal: No puede hacer reintegro, mensaje de que espere -->\r\n  <ng-template #waitToRefundModal>\r\n    <app-info-modal\r\n      head=\"deposit_cancel_imposition_title\"\r\n      description=\"deposit_cancel_imposition_wait_text\"\r\n      type=\"warning\"\r\n      (hide)=\"closeModal()\"\r\n    ></app-info-modal>\r\n  </ng-template>\r\n\r\n  <!-- Modal: no puede cancelar deposito -->\r\n  <ng-template #invalidCancelationModal>\r\n    <app-info-modal\r\n      head=\"deposit_cancel_title\"\r\n      description=\"deposit_cancel_subtitle\"\r\n      type=\"warning\"\r\n      (hide)=\"closeModal()\"\r\n    ></app-info-modal>\r\n  </ng-template>\r\n\r\n  <!-- Modal: cancelar deposito OK -->\r\n  <ng-template #successCancelDeposit>\r\n    <app-info-modal\r\n      head=\"deposit_cancel_success_title\"\r\n      description=\"deposit_cancel_success_description\"\r\n      type=\"success\"\r\n      (hide)=\"closeModal()\"\r\n    ></app-info-modal>\r\n  </ng-template>\r\n\r\n  <!-- Modal: confirmar cancelar deposito -->\r\n  <ng-template #confirmCancelDepositModal>\r\n    <app-confirm-modal\r\n      description=\"deposit_cancel2_subtitle_web\"\r\n      (confirm)=\"onCancelDeposit($event, state?.deposit)\"\r\n    >\r\n    </app-confirm-modal>\r\n  </ng-template>\r\n\r\n  <!-- Modal: confirmar anular ingreso -->\r\n  <ng-template #confirmRefundModal>\r\n    <app-confirm-modal\r\n      description=\"deposit_cancel_imposition_text_web\"\r\n      (confirm)=\"confirmRefundImposition($event, state.deposit.Acuerdo)\"\r\n    >\r\n    </app-confirm-modal>\r\n  </ng-template>\r\n\r\n  <!-- Modal: anular ingreso otp -->\r\n  <ng-template #refundOtpModal>\r\n    <app-otp-form\r\n      [invalidCode]=\"invalidRefundOtpCode\"\r\n      (repeat)=\"generateRefundOtp(state.deposit.Acuerdo)\"\r\n      (send)=\"refundImposition($event, state.deposit.Acuerdo)\"\r\n      (hide)=\"closeModal()\"\r\n    ></app-otp-form>\r\n  </ng-template>\r\n</ng-container>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  TemplateRef,\r\n  ViewChild,\r\n  Inject,\r\n} from '@angular/core';\r\nimport { DepositService } from '@core/services/deposit/deposit.service';\r\nimport { Subscription, combineLatest } from 'rxjs';\r\nimport { HeaderService } from '@core/services/header/header.service';\r\nimport { GlobalPositionService } from '@core/services/global-position/global-position.service';\r\nimport { switchMap, filter, map, tap } from 'rxjs/operators';\r\nimport { findDeposit, findAccount, isInvalidOtp } from '@core/utils';\r\nimport { ListaImposicionesCliente, FinancialAccount } from '@api/models';\r\nimport { BsModalService, BsModalRef } from 'ngx-bootstrap/modal';\r\nimport { ErrorHandlerService } from '@core/services/errors/error-handler.service';\r\nimport { Router, ActivatedRoute } from '@angular/router';\r\nimport { ImpositionStatus } from '@core/constants';\r\nimport { CaseService } from '@core/services/case/case.service';\r\nimport { CasePayload } from '@api/models/case-payload.model';\r\nimport { CASE_CANCELLATIONS } from '@core/config/sub-cases';\r\nimport { CASES } from '@core/config/cases';\r\nimport { b64toBlob } from '@core/utils/file.utils';\r\nimport { Banners, BANNERS } from '@core/constants/banners.constants';\r\nimport { AccountService } from '@core/services/account/account.service';\r\nimport * as moment from 'moment';\r\nimport { ClientType } from '@core/constants/client-type.constants';\r\n\r\n@Component({\r\n  selector: 'app-deposit',\r\n  templateUrl: './deposit.component.html',\r\n  styles: [],\r\n  changeDetection: ChangeDetectionStrategy.OnPush,\r\n})\r\nexport class DepositComponent implements OnInit, OnDestroy {\r\n  @ViewChild('refundOtpModal') refundOtpModal: TemplateRef<any>;\r\n  @ViewChild('confirmRefundModal') confirmRefundModal: TemplateRef<any>;\r\n  @ViewChild('confirmCancelDepositModal') confirmCancelDepositModal: TemplateRef<any>;\r\n  @ViewChild('invalidCancelationModal') invalidCancelationModal: TemplateRef<any>;\r\n  @ViewChild('successCancelDeposit') successCancelDepositModal: TemplateRef<any>;\r\n  readonly state$ = this.createStateStream();\r\n\r\n  invalidRefundOtpCode = false;\r\n\r\n  private selectedImposition: ListaImposicionesCliente;\r\n  private refundOtpId: string;\r\n  private modalRef: BsModalRef;\r\n  private subs = new Subscription();\r\n\r\n  constructor(\r\n    private depositService: DepositService,\r\n    private headerService: HeaderService,\r\n    private globalPositionService: GlobalPositionService,\r\n    private modalService: BsModalService,\r\n    private errorHandler: ErrorHandlerService,\r\n    private router: Router,\r\n    private activatedRoute: ActivatedRoute,\r\n    private caseService: CaseService,\r\n    private accountService: AccountService,\r\n    @Inject(BANNERS) public readonly banners: Banners\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.headerService.updateTitle('menu_deposits_web');\r\n    this.globalPositionService.fetchGlobalPosition();\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.subs.unsubscribe();\r\n    this.closeModal();\r\n  }\r\n\r\n  openModal(ref: any) {\r\n    if (!this.modalService.getModalsCount()) {\r\n      this.modalRef = this.modalService.show(ref);\r\n    }\r\n  }\r\n\r\n  closeModal() {\r\n    this.modalRef?.hide();\r\n  }\r\n\r\n  askCancelDeposit(impositions: ListaImposicionesCliente[]) {\r\n    const activeImpositionsCount = impositions?.filter(\r\n      (imposition) => imposition.descripcionEstadoImposicion === ImpositionStatus.Activo\r\n    ).length;\r\n\r\n    if (activeImpositionsCount === 0) {\r\n      this.openModal(this.confirmCancelDepositModal);\r\n    } else {\r\n      this.openModal(this.invalidCancelationModal);\r\n    }\r\n  }\r\n\r\n  onCancelDeposit(accept: boolean, deposit: FinancialAccount) {\r\n    this.closeModal();\r\n    if (accept) {\r\n      this.cancelDeposit(deposit);\r\n    }\r\n  }\r\n\r\n  askRefundImposition(imposition: ListaImposicionesCliente) {\r\n    this.selectedImposition = imposition;\r\n    this.openModal(this.confirmRefundModal);\r\n  }\r\n\r\n  onShowReceipt(deposit: FinancialAccount, imposition: ListaImposicionesCliente) {\r\n    const fileName = `imposition-receipt-${deposit.Acuerdo}-${imposition.subacuerdo}.pdf`;\r\n\r\n    this.subs.add(\r\n      this.depositService\r\n        .getPdfImposition(deposit?.Acuerdo, imposition?.subacuerdo)\r\n        .pipe(b64toBlob())\r\n        .subscribe(\r\n          (blob) => {\r\n            const a = document.createElement('a');\r\n            a.href = URL.createObjectURL(blob);\r\n            a.download = fileName;\r\n            a.click();\r\n          },\r\n          (error) => {\r\n            this.errorHandler.showError(error);\r\n          }\r\n        )\r\n    );\r\n  }\r\n\r\n  confirmRefundImposition(result: boolean, depositAgreement: string) {\r\n    this.closeModal();\r\n    if (result) {\r\n      this.generateRefundOtp(depositAgreement);\r\n    }\r\n  }\r\n\r\n  generateRefundOtp(depositAgreement: string) {\r\n    this.invalidRefundOtpCode = false;\r\n    this.refundOtpId = null;\r\n\r\n    this.subs.add(\r\n      this.depositService\r\n        .generateRefundImpositionOTP({\r\n          depositAgreement,\r\n          impositionAgreement: this.selectedImposition?.subacuerdo,\r\n          nominalAmount: String(parseFloat(this.selectedImposition?.importeNominal)),\r\n        })\r\n        .subscribe(\r\n          ({ otpId }) => {\r\n            this.openModal(this.refundOtpModal);\r\n            this.refundOtpId = otpId;\r\n          },\r\n          (error) => {\r\n            this.errorHandler.showError(error);\r\n          }\r\n        )\r\n    );\r\n  }\r\n\r\n  refundImposition(secretKey: string, depositAgreement: string) {\r\n    this.subs.add(\r\n      this.depositService\r\n        .refundImposition({\r\n          depositAgreement,\r\n          impositionAgreement: this.selectedImposition?.subacuerdo,\r\n          nominalAmount: this.selectedImposition?.importeNominal,\r\n          otp: {\r\n            otpId: this.refundOtpId,\r\n            secretKey,\r\n          },\r\n        })\r\n        .subscribe(\r\n          () => {\r\n            this.closeModal();\r\n            this.router.navigate(['./refund-success'], {\r\n              queryParams: { importeNominal: this.selectedImposition?.importeNominal },\r\n              skipLocationChange: true,\r\n              relativeTo: this.activatedRoute,\r\n            });\r\n          },\r\n          (error) => {\r\n            if (isInvalidOtp(error)) {\r\n              this.invalidRefundOtpCode = true;\r\n              return;\r\n            }\r\n\r\n            this.closeModal();\r\n            this.errorHandler.showError(error);\r\n          }\r\n        )\r\n    );\r\n  }\r\n\r\n  onConfirmRefundSuccessModal() {\r\n    this.globalPositionService.fetchGlobalPosition();\r\n    this.closeModal();\r\n  }\r\n\r\n  trackByDates(item: { [key: string]: ListaImposicionesCliente }) {\r\n    return item.date;\r\n  }\r\n\r\n  trackByImposition(imposition: ListaImposicionesCliente) {\r\n    return imposition.subacuerdo;\r\n  }\r\n\r\n  emptyImpositions(impositions: []) {\r\n    return impositions && impositions.length === 0;\r\n  }\r\n\r\n  canShowCancelDeposit(impositions: ListaImposicionesCliente[], clientType: ClientType) {\r\n    const expirationDates = impositions?.map((it) => moment(it.fechaVencimiento));\r\n    const recentExpirationDate = moment.max(expirationDates);\r\n    const isEmployee = clientType === ClientType.Employee;\r\n\r\n    return isEmployee || (!isEmployee && moment().isSameOrAfter(recentExpirationDate));\r\n  }\r\n\r\n  private cancelDeposit(deposit: FinancialAccount) {\r\n    const body = new CasePayload();\r\n    body.type = CASE_CANCELLATIONS.TOTAL_CANCELLATION_OF_THE_TERM_DEPOSIT;\r\n    body.recordTypeDeveloperName = CASES.CANCELLATIONS;\r\n    body.description = 'CancelaciÃ³n de depÃ³sito';\r\n    body.subject = 'CancelaciÃ³n de depÃ³sito';\r\n    body.newIBAN = deposit?.IBAN;\r\n\r\n    this.subs.add(\r\n      this.caseService.createCase({ caseList: [body] }).subscribe(\r\n        () => {\r\n          this.closeModal();\r\n          this.openModal(this.successCancelDepositModal);\r\n        },\r\n        (error) => {\r\n          this.errorHandler.showError(error);\r\n        }\r\n      )\r\n    );\r\n  }\r\n\r\n  private createStateStream() {\r\n    const globalPosition$ = this.globalPositionService.globalPosition$.pipe(\r\n      filter((globalPosition) => !!globalPosition)\r\n    );\r\n\r\n    return combineLatest([\r\n      globalPosition$,\r\n      globalPosition$.pipe(findDeposit()).pipe(\r\n        tap((deposit) => {\r\n          if (!deposit) {\r\n            this.router.navigate(['./hire'], { relativeTo: this.activatedRoute });\r\n          }\r\n        })\r\n      ),\r\n      globalPosition$.pipe(findAccount()),\r\n      this.createImpositionsStream(),\r\n      this.accountService.currentCustomer$,\r\n    ]).pipe(\r\n      map(([globalPosition, deposit, account, impositions, currentCustomer]) => ({\r\n        globalPosition,\r\n        deposit,\r\n        account,\r\n        impositions,\r\n        currentCustomer,\r\n      }))\r\n    );\r\n  }\r\n\r\n  private createImpositionsStream() {\r\n    return this.globalPositionService.globalPosition$.pipe(\r\n      findDeposit(),\r\n      filter((deposit) => !!deposit?.Acuerdo),\r\n      switchMap((deposit) => this.depositService.getImpositions(deposit?.Acuerdo))\r\n    );\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Imposition, ApiError, ImpositionOutput } from '@api/models';\r\nimport { Subscription, Observable, zip } from 'rxjs';\r\nimport { DepositService } from '@core/services/deposit/deposit.service';\r\nimport { switchMap, map } from 'rxjs/operators';\r\nimport { GlobalPositionService } from '@core/services/global-position/global-position.service';\r\nimport { findDeposit, findAccount } from '@core/utils';\r\nimport { DictionaryService } from '@core/services/dictionary/dictionary.service';\r\n\r\n@Injectable()\r\nexport class ImpositionService {\r\n  readonly state$ = this.createState();\r\n  readonly impositionConditions$ = this.dictionaryService.getImpositionConditions();\r\n\r\n  private imposition: Imposition;\r\n  private referenceOTP: string;\r\n  private subs = new Subscription();\r\n\r\n  constructor(\r\n    private depositService: DepositService,\r\n    private globalPositionService: GlobalPositionService,\r\n    private dictionaryService: DictionaryService\r\n  ) {}\r\n\r\n  initImposition(imposition: Imposition) {\r\n    this.imposition = imposition;\r\n  }\r\n\r\n  fetchGlobalPosition() {\r\n    this.globalPositionService.fetchGlobalPosition();\r\n  }\r\n\r\n  generateOtp(onSuccess?: () => void, onError?: (error: ApiError) => void) {\r\n    this.referenceOTP = null;\r\n\r\n    const generateOtp = (imposition: Imposition) =>\r\n      this.depositService.generateCreateImpositionOTP({ ...imposition });\r\n\r\n    this.subs.add(\r\n      this.state$\r\n        .pipe(\r\n          switchMap((state) =>\r\n            generateOtp({ ...this.imposition, depositAgreement: state?.deposit?.Acuerdo })\r\n          )\r\n        )\r\n        .subscribe(\r\n          ({ otpId }) => {\r\n            this.referenceOTP = otpId;\r\n            onSuccess?.();\r\n          },\r\n          (error) => onError?.(error)\r\n        )\r\n    );\r\n  }\r\n\r\n  createImposition(secretKey: string, onSuccess?: () => void, onError?: (error: ApiError) => void) {\r\n    this.subs.add(\r\n      this.state$\r\n        .pipe(\r\n          switchMap((state) =>\r\n            this.depositService.createImposition({\r\n              ...this.imposition,\r\n              depositAgreement: state?.deposit.Acuerdo,\r\n              otp: { secretKey, otpId: this.referenceOTP },\r\n            })\r\n          )\r\n        )\r\n        .subscribe(\r\n          () => {\r\n            onSuccess?.();\r\n          },\r\n          (error) => {\r\n            onError?.(error);\r\n          }\r\n        )\r\n    );\r\n  }\r\n\r\n  destroy() {\r\n    this.subs.unsubscribe();\r\n  }\r\n\r\n  private createState() {\r\n    return zip(\r\n      this.globalPositionService.globalPosition$,\r\n      this.globalPositionService.globalPosition$.pipe(findDeposit()),\r\n      this.globalPositionService.globalPosition$.pipe(findAccount())\r\n    ).pipe(\r\n      map(([globalPosition, deposit, account]) => ({\r\n        globalPosition,\r\n        deposit,\r\n        account,\r\n      }))\r\n    );\r\n  }\r\n}\r\n","import { FormGroup, AbstractControl } from '@angular/forms';\r\nimport { ImpositionCondition } from '@api/models';\r\nimport { parseLocaleNumber } from '@shared/directives/parse-currency.directive';\r\n\r\nexport function amountValidator(formGroup: FormGroup) {\r\n  const impositionConditionInput = formGroup.get('impositionCondition');\r\n  const amountInput = formGroup.get('amount');\r\n\r\n  const impositionCondition: ImpositionCondition = impositionConditionInput.value;\r\n  const amount = parseLocaleNumber(amountInput.value);\r\n\r\n  if (!impositionCondition) {\r\n    return null;\r\n  }\r\n\r\n  if (impositionCondition?.maximum < amount) {\r\n    return { maxImposition: true };\r\n  }\r\n\r\n  if (impositionCondition?.minimum > amount) {\r\n    return { minImposition: true };\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nexport function balanceValidator(balance: number) {\r\n  return (control: AbstractControl) => {\r\n    const amount = parseLocaleNumber(control?.value);\r\n    return amount > balance ? { balanceError: true } : null;\r\n  };\r\n}\r\n","import { InjectionToken, inject } from '@angular/core';\r\nimport { AccountService } from '@core/services/account/account.service';\r\nimport { ClientType } from './client-type.constants';\r\nimport { environment } from '@environment/environment';\r\n\r\nexport interface ExternalDocuments {\r\n  impositionConditions: string;\r\n  particularConditions: string;\r\n}\r\n\r\nconst documents = environment.applications.documents;\r\n\r\nconst employeeDocuments: ExternalDocuments = {\r\n  impositionConditions: `${documents}/documentacion-legal/condiciones-imposicion-RenaultBank.pdf`,\r\n  particularConditions: `${documents}/documentacion-legal/informacion-precontractual-deposito-RenaultBank.pdf`,\r\n};\r\n\r\nconst notEmployeeDocuments: ExternalDocuments = {\r\n  impositionConditions: `${documents}/documentacion-legal/condiciones-imposicion-publico-RenaultBank.pdf`,\r\n  particularConditions: `${documents}/documentacion-legal/informacion-precontractual-deposito-publico-RenaultBank.pdf`,\r\n};\r\n\r\nexport const EXTERNAL_DOCUMENTS = new InjectionToken<ExternalDocuments>('EXTERNAL_DOCUMENTS', {\r\n  providedIn: 'root',\r\n  factory: () => {\r\n    const accountService = inject(AccountService);\r\n    const clientType = accountService.currentCustomer?.DatosPersonales?.clientType;\r\n\r\n    if (clientType === ClientType.Employee) {\r\n      return employeeDocuments;\r\n    }\r\n\r\n    return notEmployeeDocuments;\r\n  },\r\n});\r\n","<form [formGroup]=\"form\" (submit)=\"onSubmit()\" *ngIf=\"!showConfirm; else confirm\">\r\n  <div class=\"group-input\">\r\n    <label>{{ 'deposit_sender_account' | translate }}</label>\r\n    <p class=\"input\">{{ account?.IBAN | formatIban }}</p>\r\n  </div>\r\n  <div class=\"group-input\">\r\n    <label>{{ 'deposit_receiver_account' | translate }}</label>\r\n    <p class=\"input\">{{ deposit?.IBAN | formatIban }}</p>\r\n  </div>\r\n  <div class=\"group-input\">\r\n    <label>{{ 'deposit_new_imposition_account_balance' | translate }}</label>\r\n    <p class=\"input\">{{ account?.Balance || 0 | number: '1.2-2' }}</p>\r\n  </div>\r\n  <div class=\"group-input\">\r\n    <label>{{ 'deposit_amount' | translate }}</label>\r\n    <input\r\n      formControlName=\"amount\"\r\n      type=\"text\"\r\n      appParseCurrency\r\n      [allowDecimal]=\"false\"\r\n      [ngClass]=\"{\r\n        error: hasError(form.get('amount')) || hasMaxAmountError || hasMinAmountError\r\n      }\"\r\n      maxlength=\"10\"\r\n    />\r\n\r\n    <p class=\"error-text\" *ngIf=\"hasBalanceError && !hasMinAmountError && !hasMaxAmountError\">\r\n      <span class=\"ico-alert\"></span>\r\n      {{ 'deposit_hire_amount_account_insufficient' | translate }}\r\n    </p>\r\n\r\n    <p class=\"error-text\" *ngIf=\"hasMinAmountError\">\r\n      <span class=\"ico-alert\"></span>\r\n      {{\r\n        'deposit_hire_minnimum_import_web'\r\n          | translate: { amount: impositionCondition?.minimum | currency }\r\n      }}\r\n    </p>\r\n\r\n    <p class=\"error-text\" *ngIf=\"hasMaxAmountError\">\r\n      <span class=\"ico-alert\"></span>\r\n      {{\r\n        'deposit_hire_maximum_import_web'\r\n          | translate: { amount: impositionCondition?.maximum | currency }\r\n      }}\r\n    </p>\r\n  </div>\r\n\r\n  <div class=\"group-input input-select\">\r\n    <label>{{ 'deposit_time' | translate }}</label>\r\n    <ng-select\r\n      [items]=\"impositionConditions\"\r\n      [placeholder]=\"'deposit_time_election' | translate\"\r\n      formControlName=\"impositionCondition\"\r\n      [ngClass]=\"{ error: hasError(form.get('impositionCondition')) }\"\r\n      [searchable]=\"false\"\r\n      [clearable]=\"false\"\r\n    >\r\n      <ng-template ng-label-tmp ng-option-tmp let-item=\"item\">\r\n        {{ 'deposit_time_options_web' | translate: { time: item.duration } }}\r\n      </ng-template>\r\n    </ng-select>\r\n  </div>\r\n\r\n  <div class=\"group-input input-checkbox\">\r\n    <input\r\n      type=\"checkbox\"\r\n      formControlName=\"conditions\"\r\n      id=\"conditions\"\r\n      [ngClass]=\"{ error: hasError(form.get('conditions')) }\"\r\n    />\r\n    <label for=\"conditions\"\r\n      >{{ 'deposit_new_imposition_condition_1_web' | translate }}&nbsp;\r\n      <a (click)=\"readConditions()\" href=\"javascript:;\">\r\n        {{ 'deposit_new_imposition_condition_2_web' | translate }}</a\r\n      >\r\n    </label>\r\n    <span class=\"check ico-check-2\"></span>\r\n    <p class=\"error-text\" *ngIf=\"!this.conditionsRead && this.submitted\">\r\n      <span class=\"ico-alert\"></span>{{ 'deposit_new_imposition_must_read_conditions' | translate }}\r\n    </p>\r\n  </div>\r\n  <div class=\"group-button\">\r\n    <button type=\"submit\" class=\"btn--primary\">\r\n      {{ 'generic_continue_button' | translate }}\r\n    </button>\r\n    <button routerLink=\"../..\" type=\"button\" class=\"btn--secondary\">\r\n      {{ 'deposit_cancel' | translate }}\r\n    </button>\r\n  </div>\r\n\r\n  <div class=\"main__button group-button\">\r\n    <button routerLink=\"../..\" type=\"button\" class=\"btn--secondary\">\r\n      {{ 'deposit_cancel' | translate }}\r\n    </button>\r\n    <button type=\"submit\" class=\"btn--primary\">\r\n      {{ 'deposit_continue' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n\r\n<ng-template #confirm>\r\n  <div class=\"deposit-confirm\">\r\n    <div class=\"group-input\">\r\n      <label>{{ 'deposit_sender_account' | translate }}</label>\r\n      <p>{{ account?.IBAN | formatIban }}</p>\r\n    </div>\r\n\r\n    <div class=\"group-input\">\r\n      <label>{{ 'deposit_receiver_account' | translate }}</label>\r\n      <p>{{ deposit?.IBAN | formatIban }}</p>\r\n    </div>\r\n\r\n    <div class=\"group-input\">\r\n      <label>{{ 'deposit_new_impositon_amount' | translate }}</label>\r\n      <p>{{ imposition?.nominalAmount | currency }}</p>\r\n    </div>\r\n\r\n    <div class=\"group-input\">\r\n      <label>{{ 'deposit_imposition_term' | translate }}</label>\r\n      <p>\r\n        {{\r\n          'deposit_new_imposition_term_value_web'\r\n            | translate\r\n              : {\r\n                  term: impositionCondition?.duration | number\r\n                }\r\n        }}\r\n      </p>\r\n    </div>\r\n\r\n    <div class=\"group-input\">\r\n      <label>{{ 'deposit_new_imposition_fee' | translate }}</label>\r\n      <p>0,00 %</p>\r\n    </div>\r\n    <div class=\"group-button\">\r\n      <button type=\"button\" (click)=\"makeImposition.emit(imposition)\" class=\"btn--primary\">\r\n        {{ 'generic_confirm_button' | translate }}\r\n      </button>\r\n    </div>\r\n    <div class=\"main__button\">\r\n      <button type=\"submit\" class=\"btn--primary\" (click)=\"makeImposition.emit(imposition)\">\r\n        {{ 'generic_confirm_button' | translate }}\r\n      </button>\r\n    </div>\r\n  </div>\r\n</ng-template>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  Inject,\r\n} from '@angular/core';\r\nimport { FormBuilder, FormGroup, Validators, AbstractControl } from '@angular/forms';\r\nimport { amountValidator, balanceValidator } from '@deposit/utils/imposition.validators';\r\nimport { ImpositionCondition, Imposition, FinancialAccount } from '@api/models';\r\nimport { parseLocaleNumber } from '@shared/directives/parse-currency.directive';\r\nimport {\r\n  EXTERNAL_DOCUMENTS,\r\n  ExternalDocuments,\r\n} from '@core/constants/external-documents.constants';\r\n\r\n@Component({\r\n  selector: 'app-new-imposition-form',\r\n  templateUrl: './new-imposition-form.component.html',\r\n  styles: [],\r\n  changeDetection: ChangeDetectionStrategy.OnPush,\r\n})\r\nexport class NewImpositionFormComponent implements OnInit {\r\n  @Input() impositionConditions: ImpositionCondition[];\r\n  @Input() account: FinancialAccount;\r\n  @Input() deposit: FinancialAccount;\r\n  @Output() makeImposition = new EventEmitter<Imposition>();\r\n\r\n  form: FormGroup;\r\n  submitted = false;\r\n  imposition: Imposition;\r\n  showConfirm = false;\r\n  conditionsRead = false;\r\n\r\n  //  utils to template\r\n  get hasBalanceError() {\r\n    const amount = this.form.get('amount');\r\n    return this.hasError(amount) && amount.hasError('balanceError');\r\n  }\r\n\r\n  get hasMinAmountError() {\r\n    return this.form.hasError('minImposition');\r\n  }\r\n\r\n  get hasMaxAmountError() {\r\n    return this.form.hasError('maxImposition');\r\n  }\r\n\r\n  get impositionCondition(): ImpositionCondition {\r\n    return this.form?.get('impositionCondition').value;\r\n  }\r\n\r\n  constructor(\r\n    private fb: FormBuilder,\r\n    @Inject(EXTERNAL_DOCUMENTS) private externalDocuments: ExternalDocuments\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.createForm();\r\n  }\r\n\r\n  onSubmit() {\r\n    this.submitted = true;\r\n    this.form.markAllAsTouched();\r\n\r\n    if (this.form.valid && this.conditionsRead) {\r\n      const impositionCondition: ImpositionCondition = this.form.value.impositionCondition;\r\n      this.imposition = {\r\n        nominalAmount: parseLocaleNumber(this.form.value.amount).toString(),\r\n        duration: impositionCondition?.duration,\r\n        frecuency: impositionCondition?.settFrequency,\r\n      };\r\n\r\n      this.showConfirm = true;\r\n    }\r\n  }\r\n\r\n  hasError(control: AbstractControl) {\r\n    return control.touched && control.invalid;\r\n  }\r\n\r\n  readConditions() {\r\n    this.conditionsRead = true;\r\n    window?.open(this.externalDocuments.impositionConditions);\r\n  }\r\n\r\n  private createForm() {\r\n    this.form = this.fb.group(\r\n      {\r\n        amount: ['', [Validators.required, balanceValidator(this.account?.Balance)]],\r\n        impositionCondition: [null, Validators.required],\r\n        conditions: [false, [Validators.requiredTrue]],\r\n      },\r\n      { validators: amountValidator }\r\n    );\r\n  }\r\n}\r\n","<ng-container *ngIf=\"state$ | async as state\">\r\n  <div class=\"max-size deposit-form\" *ngIf=\"state.globalPosition\">\r\n    <div class=\"main\">\r\n      <div class=\"main-col no-aside\">\r\n        <div class=\"main__header\">\r\n          <div class=\"main__header__desktop\">\r\n            <div class=\"main__header__title\">\r\n              <div class=\"main__header__title__col\">\r\n                <h1>{{ 'deposit_new_imposition_title' | translate }}</h1>\r\n                <p>{{ state.deposit?.IBAN | formatIban }}</p>\r\n              </div>\r\n              <div class=\"main__header__title__col\">\r\n                <p>{{ 'deposit_new_imposition_account_balance' | translate }}</p>\r\n                <h1>{{ state.account?.Balance | currency }}</h1>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div class=\"main__body\">\r\n          <app-new-imposition-form\r\n            [account]=\"state?.account\"\r\n            [deposit]=\"state?.deposit\"\r\n            [impositionConditions]=\"impositionConditions$ | async\"\r\n            (makeImposition)=\"onMakeImposition($event)\"\r\n          ></app-new-imposition-form>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n\r\n  <ng-template #otpModal>\r\n    <app-otp-form\r\n      [invalidCode]=\"invalidImpositionOtpCode\"\r\n      (send)=\"createImposition($event)\"\r\n      (repeat)=\"generateOtp()\"\r\n      (hide)=\"closeModal()\"\r\n    ></app-otp-form>\r\n  </ng-template>\r\n</ng-container>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  ViewChild,\r\n  TemplateRef,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Self,\r\n} from '@angular/core';\r\nimport { Imposition } from '@api/models';\r\nimport { BsModalService, BsModalRef } from 'ngx-bootstrap/modal';\r\nimport { isInvalidOtp } from '@core/utils';\r\nimport { Router, ActivatedRoute } from '@angular/router';\r\nimport { ErrorHandlerService } from '@core/services/errors/error-handler.service';\r\nimport { ImpositionService } from '@deposit/services/imposition.service';\r\n\r\n@Component({\r\n  selector: 'app-new-imposition',\r\n  templateUrl: './new-imposition.component.html',\r\n  styles: [],\r\n  changeDetection: ChangeDetectionStrategy.OnPush,\r\n  providers: [ImpositionService],\r\n})\r\nexport class NewImpositionComponent implements OnInit, OnDestroy {\r\n  readonly state$ = this.impositionService.state$;\r\n  readonly impositionConditions$ = this.impositionService.impositionConditions$;\r\n  @ViewChild('otpModal') otpModal: TemplateRef<any>;\r\n\r\n  invalidImpositionOtpCode = false;\r\n  private modalRef: BsModalRef;\r\n\r\n  constructor(\r\n    private modalService: BsModalService,\r\n    private router: Router,\r\n    private route: ActivatedRoute,\r\n    private errorHandler: ErrorHandlerService,\r\n    @Self() private impositionService: ImpositionService\r\n  ) {}\r\n\r\n  ngOnInit() {}\r\n\r\n  ngOnDestroy() {\r\n    this.closeModal();\r\n    this.impositionService.destroy();\r\n  }\r\n\r\n  openModal(ref: any) {\r\n    if (!this.modalService.getModalsCount()) {\r\n      this.modalRef = this.modalService.show(ref);\r\n    }\r\n  }\r\n\r\n  closeModal() {\r\n    this.modalRef?.hide();\r\n  }\r\n\r\n  onMakeImposition(imposition: Imposition) {\r\n    this.impositionService.initImposition(imposition);\r\n    this.generateOtp();\r\n  }\r\n\r\n  generateOtp() {\r\n    this.invalidImpositionOtpCode = false;\r\n\r\n    this.impositionService.generateOtp(\r\n      () => {\r\n        this.openModal(this.otpModal);\r\n      },\r\n      (error) => {\r\n        this.errorHandler.showError(error);\r\n      }\r\n    );\r\n  }\r\n\r\n  createImposition(secretKey: string) {\r\n    this.impositionService.createImposition(\r\n      secretKey,\r\n      () => {\r\n        this.closeModal();\r\n        this.navigateToSuccessPage();\r\n      },\r\n      (error) => {\r\n        if (isInvalidOtp(error)) {\r\n          this.invalidImpositionOtpCode = true;\r\n          return;\r\n        }\r\n        this.closeModal();\r\n        this.errorHandler.showError(error);\r\n      }\r\n    );\r\n  }\r\n\r\n  private navigateToSuccessPage() {\r\n    this.router.navigate(['../new-imposition-success'], {\r\n      skipLocationChange: true,\r\n      relativeTo: this.route,\r\n    });\r\n  }\r\n}\r\n","import { Subject } from '../Subject';\nimport { OuterSubscriber } from '../OuterSubscriber';\nimport { subscribeToResult } from '../util/subscribeToResult';\nexport function retryWhen(notifier) {\n    return (source) => source.lift(new RetryWhenOperator(notifier, source));\n}\nclass RetryWhenOperator {\n    constructor(notifier, source) {\n        this.notifier = notifier;\n        this.source = source;\n    }\n    call(subscriber, source) {\n        return source.subscribe(new RetryWhenSubscriber(subscriber, this.notifier, this.source));\n    }\n}\nclass RetryWhenSubscriber extends OuterSubscriber {\n    constructor(destination, notifier, source) {\n        super(destination);\n        this.notifier = notifier;\n        this.source = source;\n    }\n    error(err) {\n        if (!this.isStopped) {\n            let errors = this.errors;\n            let retries = this.retries;\n            let retriesSubscription = this.retriesSubscription;\n            if (!retries) {\n                errors = new Subject();\n                try {\n                    const { notifier } = this;\n                    retries = notifier(errors);\n                }\n                catch (e) {\n                    return super.error(e);\n                }\n                retriesSubscription = subscribeToResult(this, retries);\n            }\n            else {\n                this.errors = null;\n                this.retriesSubscription = null;\n            }\n            this._unsubscribeAndRecycle();\n            this.errors = errors;\n            this.retries = retries;\n            this.retriesSubscription = retriesSubscription;\n            errors.next(err);\n        }\n    }\n    _unsubscribe() {\n        const { errors, retriesSubscription } = this;\n        if (errors) {\n            errors.unsubscribe();\n            this.errors = null;\n        }\n        if (retriesSubscription) {\n            retriesSubscription.unsubscribe();\n            this.retriesSubscription = null;\n        }\n        this.retries = null;\n    }\n    notifyNext(outerValue, innerValue, outerIndex, innerIndex, innerSub) {\n        const { _unsubscribe } = this;\n        this._unsubscribe = null;\n        this._unsubscribeAndRecycle();\n        this._unsubscribe = _unsubscribe;\n        this.source.subscribe(this);\n    }\n}\n//# sourceMappingURL=retryWhen.js.map","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { environment } from '@environment/environment';\r\nimport { ApiErrors } from '@api/constants';\r\nimport {\r\n  ResponseSubmitEvicertia,\r\n  ResponseBulkSignEvicertia,\r\n  ResponseQuerySignEvicertia,\r\n} from '@api/models';\r\nimport { map } from 'rxjs/operators';\r\n\r\n@Injectable({\r\n  providedIn: 'root',\r\n})\r\nexport class HireDepositService {\r\n  constructor(private http: HttpClient) {}\r\n\r\n  newHiring(productid: string) {\r\n    const params = { productid };\r\n    return this.http.post(\r\n      `${environment.apiBasePath}${environment.endpoints.deposit.newHiring}`,\r\n      null,\r\n      { params }\r\n    );\r\n  }\r\n\r\n  getPdfContract() {\r\n    return this.http.get(\r\n      `${environment.apiBasePath}${environment.endpoints.deposit.getPdfContract}`\r\n    );\r\n  }\r\n\r\n  // proceso de firma\r\n  startSignProcessSubmit() {\r\n    return this.http\r\n      .post<ResponseSubmitEvicertia>(\r\n        `${environment.apiBasePath}${environment.endpoints.sign.startSignProcessSubmit}`,\r\n        null\r\n      )\r\n      .pipe(\r\n        map((data) => {\r\n          if (data?.code === ApiErrors.ERROR_SUBMIT) {\r\n            throw {\r\n              errorCode: data?.code,\r\n              message: data?.code,\r\n            };\r\n          }\r\n\r\n          return data?.data[0]?.uniqueId;\r\n        })\r\n      );\r\n  }\r\n\r\n  startSignProcessBulkSign() {\r\n    return this.http\r\n      .post<ResponseBulkSignEvicertia>(\r\n        `${environment.apiBasePath}${environment.endpoints.sign.startSignProcessBulkSign}`,\r\n        null\r\n      )\r\n      .pipe(\r\n        map((data) => {\r\n          if (\r\n            data?.code === ApiErrors.ERROR_BULKSIGN ||\r\n            data?.code === ApiErrors.ERROR_BULKSIGN_REQUESTNEWSUBMIT\r\n          ) {\r\n            throw { errorCode: data?.code, message: data?.code };\r\n          }\r\n\r\n          return data?.data[0];\r\n        })\r\n      );\r\n  }\r\n\r\n  querySignProcess() {\r\n    return this.http.post<ResponseQuerySignEvicertia>(\r\n      `${environment.apiBasePath}${environment.endpoints.sign.querySignProcess}`,\r\n      null\r\n    );\r\n  }\r\n}\r\n","import { Component, OnInit, ChangeDetectionStrategy, Input } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'app-hire-deposit-status-bar',\r\n  templateUrl: './hire-deposit-status-bar.component.html',\r\n  styles: [],\r\n  changeDetection: ChangeDetectionStrategy.OnPush,\r\n})\r\nexport class HireDepositStatusBarComponent {\r\n  @Input() step: 0 | 1 | 2 | 3 = 0;\r\n\r\n  get firstStepClass() {\r\n    return { completed: this.step > 0, active: this.step === 0 };\r\n  }\r\n\r\n  get secondStepClass() {\r\n    return { completed: this.step > 1, active: this.step === 1 };\r\n  }\r\n\r\n  get thirdStepClass() {\r\n    return { completed: this.step > 2, active: this.step === 2 };\r\n  }\r\n\r\n  get lineClass() {\r\n    return { partial: this.step === 1, completed: this.step > 1 };\r\n  }\r\n}\r\n","<div class=\"status-bar\">\r\n  <div class=\"step\" [ngClass]=\"firstStepClass\">\r\n    <div class=\"step__circle\">\r\n      <span class=\"step__number\">1</span>\r\n      <span class=\"step__icon ico-check-2\"></span>\r\n    </div>\r\n    <p>{{ 'deposit_hire_step_one' | translate }}</p>\r\n  </div>\r\n\r\n  <div class=\"step\" [ngClass]=\"secondStepClass\">\r\n    <div class=\"step__circle\">\r\n      <span class=\"step__number\">2</span>\r\n      <span class=\"step__icon ico-check-2\"></span>\r\n    </div>\r\n    <p>{{ 'deposit_hire_step_two' | translate }}</p>\r\n  </div>\r\n\r\n  <div class=\"step\" [ngClass]=\"thirdStepClass\">\r\n    <div class=\"step__circle\">\r\n      <span class=\"step__number\">3</span>\r\n      <span class=\"step__icon ico-check-2\"></span>\r\n    </div>\r\n    <p>{{ 'deposit_hire_step_three' | translate }}</p>\r\n  </div>\r\n\r\n  <div class=\"line partial\" [ngClass]=\"lineClass\"></div>\r\n</div>\r\n","<form [formGroup]=\"form\" (submit)=\"onSubmit()\">\r\n  <div class=\"group-input\">\r\n    <label>{{ 'transfer_sender_account' | translate }}</label>\r\n    <p class=\"input\">{{ account?.IBAN | formatIban }}</p>\r\n  </div>\r\n\r\n  <div class=\"description\">\r\n    <label>{{ 'deposit_hire_conditions_description' | translate }}</label>\r\n  </div>\r\n\r\n  <div class=\"group-input input-checkbox\">\r\n    <input\r\n      type=\"checkbox\"\r\n      formControlName=\"particularConditions\"\r\n      id=\"particularConditions\"\r\n      [ngClass]=\"{ error: hasError(form.get('particularConditions')) }\"\r\n    />\r\n    <label for=\"particularConditions\"\r\n      >{{ 'deposit_hire_conditions_web' | translate }}\r\n      <a (click)=\"readParticularConditions()\" href=\"javascript:;\">\r\n        {{ 'deposit_hire_particular_conditions_web' | translate }}</a\r\n      ></label\r\n    >\r\n    <span class=\"check ico-check-2\"></span>\r\n    <p class=\"error-text\" *ngIf=\"!readPdf.particularConditions && submitted\">\r\n      <span class=\"ico-alert\"></span\r\n      >{{ 'hire_deposit_must_read_particular_conditions' | translate }}\r\n    </p>\r\n  </div>\r\n\r\n  <div class=\"group-button\">\r\n    <button type=\"submit\" class=\"btn--primary\">\r\n      {{ 'deposit_continue' | translate }}\r\n    </button>\r\n  </div>\r\n\r\n  <div class=\"main__button\">\r\n    <button type=\"submit\" class=\"btn--primary\">\r\n      {{ 'deposit_continue' | translate }}\r\n    </button>\r\n  </div>\r\n</form>\r\n","import { Component, OnInit, Output, EventEmitter, Input, Inject } from '@angular/core';\r\nimport { FormGroup, Validators, FormBuilder, AbstractControl } from '@angular/forms';\r\nimport { FinancialAccount } from '@api/models';\r\nimport {\r\n  EXTERNAL_DOCUMENTS,\r\n  ExternalDocuments,\r\n} from '@core/constants/external-documents.constants';\r\n\r\n@Component({\r\n  selector: 'app-hire-deposit-form',\r\n  templateUrl: './hire-deposit-form.component.html',\r\n  styles: [],\r\n})\r\nexport class HireDepositFormComponent implements OnInit {\r\n  @Input() account: FinancialAccount;\r\n  @Output() hireDeposit = new EventEmitter<void>();\r\n  form: FormGroup;\r\n  submitted = false;\r\n\r\n  readonly readPdf = {\r\n    particularConditions: false,\r\n  };\r\n\r\n  constructor(\r\n    private formBuilder: FormBuilder,\r\n    @Inject(EXTERNAL_DOCUMENTS) private externalDocuments: ExternalDocuments\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.createForm();\r\n  }\r\n\r\n  onSubmit() {\r\n    this.submitted = true;\r\n    this.form.markAllAsTouched();\r\n\r\n    if (this.form.valid && this.readPdf.particularConditions) {\r\n      this.hireDeposit.emit();\r\n    }\r\n  }\r\n\r\n  readParticularConditions() {\r\n    this.readPdf.particularConditions = true;\r\n    window?.open(this.externalDocuments.particularConditions);\r\n  }\r\n\r\n  hasError(control: AbstractControl) {\r\n    return control.touched && control.invalid;\r\n  }\r\n\r\n  private createForm() {\r\n    this.form = this.formBuilder.group({\r\n      particularConditions: [false, [Validators.requiredTrue]],\r\n    });\r\n  }\r\n}\r\n","<ng-container *ngIf=\"state$ | async as state\">\r\n  <div class=\"max-size deposit-form\" *ngIf=\"state.globalPosition\">\r\n    <div class=\"main\">\r\n      <div class=\"main-col\">\r\n        <div class=\"main__header\">\r\n          <div class=\"main__header__desktop\">\r\n            <div class=\"main__header__title\">\r\n              <div class=\"main__header__title__col\">\r\n                <h1>{{ 'deposit_hire_title' | translate }}</h1>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div class=\"main__body\">\r\n          <p class=\"info-text\" *ngIf=\"isWorking\">\r\n            {{ 'deposit_hire_loading_contract_response' | translate }}\r\n          </p>\r\n\r\n          <app-hire-deposit-form\r\n            *ngIf=\"!isWorking\"\r\n            [account]=\"state.account\"\r\n            (hireDeposit)=\"onHireDeposit()\"\r\n          ></app-hire-deposit-form>\r\n        </div>\r\n      </div>\r\n      <div class=\"aside-col\">\r\n        <app-hire-deposit-status-bar></app-hire-deposit-status-bar>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</ng-container>\r\n","import { Component, OnInit, OnDestroy, Inject } from '@angular/core';\r\nimport { GlobalPositionService } from '@core/services/global-position/global-position.service';\r\nimport { zip, Subscription, Observable, of, throwError } from 'rxjs';\r\nimport { findAccount } from '@core/utils';\r\nimport {\r\n  map,\r\n  filter,\r\n  mergeMap,\r\n  delay,\r\n  switchMapTo,\r\n  pluck,\r\n  retryWhen,\r\n  finalize,\r\n} from 'rxjs/operators';\r\nimport { HireDepositService } from '@core/services/hire-deposit/hire-deposit.service';\r\nimport { DOCUMENT } from '@angular/common';\r\nimport { ErrorHandlerService } from '@core/services/errors/error-handler.service';\r\nimport { DictionaryService } from '@core/services/dictionary/dictionary.service';\r\nimport { ResponseBulkSignEvicertiaData, ApiError } from '@api/models';\r\nimport { ActivatedRoute } from '@angular/router';\r\nimport { ApiErrors } from '@api/constants';\r\nimport { LoadingService } from '@core/services/loading/loading.service';\r\n\r\n@Component({\r\n  selector: 'app-hire-deposit',\r\n  templateUrl: './hire-deposit.component.html',\r\n  styles: [],\r\n})\r\nexport class HireDepositComponent implements OnInit, OnDestroy {\r\n  readonly state$ = this.createState();\r\n  availablePodructId: string;\r\n  isWorking = false;\r\n\r\n  private subs = new Subscription();\r\n\r\n  constructor(\r\n    @Inject(DOCUMENT) private document: Document,\r\n    private globalPositionService: GlobalPositionService,\r\n    private hireDepositService: HireDepositService,\r\n    private errorHandler: ErrorHandlerService,\r\n    private dictionaryService: DictionaryService,\r\n    private activatedRoute: ActivatedRoute,\r\n    private loadingService: LoadingService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.checkPendingHiring();\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.subs.unsubscribe();\r\n  }\r\n\r\n  onHireDeposit() {\r\n    this.hiringProcess(this.availablePodructId);\r\n  }\r\n\r\n  private async checkPendingHiring() {\r\n    const idQueryParam = this.activatedRoute.snapshot.queryParams.id;\r\n\r\n    if (idQueryParam) {\r\n      this.availablePodructId = idQueryParam;\r\n    } else {\r\n      try {\r\n        this.availablePodructId = await this.getProductId();\r\n      } catch (error) {\r\n        this.errorHandler.redirectErrorPage(error);\r\n      }\r\n    }\r\n  }\r\n\r\n  private async getProductId() {\r\n    let productId = await this.globalPositionService\r\n      .pendingHirings()\r\n      .pipe(map((res) => res.data?.[0]?.RCI_Product__r?.ProductCode))\r\n      .toPromise();\r\n\r\n    if (!productId) {\r\n      productId = await this.getProducts().pipe(pluck('externalId')).toPromise();\r\n    }\r\n\r\n    return productId;\r\n  }\r\n\r\n  private createState() {\r\n    return zip(\r\n      this.globalPositionService.globalPosition$,\r\n      this.globalPositionService.globalPosition$.pipe(findAccount())\r\n    ).pipe(map(([globalPosition, account]) => ({ globalPosition, account })));\r\n  }\r\n\r\n  private hiringProcess(productId: string) {\r\n    this.loadingService.show();\r\n    this.isWorking = true;\r\n\r\n    this.subs.add(\r\n      this.hireDepositService\r\n        .newHiring(productId)\r\n        .pipe(\r\n          switchMapTo(this.hireDepositService.getPdfContract()),\r\n          switchMapTo(this.signDeposit())\r\n        )\r\n        .pipe(\r\n          finalize(() => {\r\n            this.loadingService.hide();\r\n            this.isWorking = false;\r\n          })\r\n        )\r\n        .subscribe(\r\n          (data) => {\r\n            this.handleSignResponse(data);\r\n          },\r\n          (error) => {\r\n            this.errorHandler.showError(error);\r\n          }\r\n        )\r\n    );\r\n  }\r\n\r\n  private handleSignResponse(data: ResponseBulkSignEvicertiaData) {\r\n    try {\r\n      const url = new URL(data?.url);\r\n      this.document.location.href = url.href;\r\n    } catch (error) {\r\n      console.error(error);\r\n    }\r\n  }\r\n\r\n  private getProducts() {\r\n    return this.dictionaryService.getProducts().pipe(map((item) => item.productList?.[0]));\r\n  }\r\n\r\n  // Sign process\r\n  private signDeposit() {\r\n    return this.hireDepositService.querySignProcess().pipe(\r\n      map((data) => data?.data),\r\n      filter((data) => !data || data?.length === 0),\r\n      mergeMap(() => this.hireDepositService.startSignProcessSubmit()),\r\n      delay(5000),\r\n      mergeMap(() => this.hireDepositService.startSignProcessBulkSign().pipe(retryWithBackoff()))\r\n    );\r\n  }\r\n}\r\n\r\nexport function retryWithBackoff() {\r\n  let retries = 3;\r\n  const delayTime = 5000;\r\n\r\n  return (src: Observable<any>) =>\r\n    src.pipe(\r\n      retryWhen((errors: Observable<any>) =>\r\n        errors.pipe(\r\n          mergeMap((error: ApiError) => {\r\n            if (error?.errorCode === ApiErrors.KO_RETRY) {\r\n              if (retries-- > 0) {\r\n                return of(error).pipe(delay(delayTime));\r\n              } else {\r\n                return throwError({ errorCode: 'MAX_RETRIES_EXCEEDED' } as ApiError);\r\n              }\r\n            } else {\r\n              retries = 5;\r\n              return throwError(error);\r\n            }\r\n          })\r\n        )\r\n      )\r\n    );\r\n}\r\n","<div class=\"max-size deposit\" *ngIf=\"state$ | async as state\">\r\n  <div class=\"main\" *ngIf=\"state.globalPosition\">\r\n    <div class=\"main-col no-aside\">\r\n      <div class=\"main__header\">\r\n        <div class=\"main__header__desktop\">\r\n          <div class=\"main__header__title\">\r\n            <div class=\"main__header__title__col\">\r\n              <h1>{{ 'deposit_cancel_imposition_title' | translate }}</h1>\r\n              <p>{{ state.deposit?.IBAN | formatIban }}</p>\r\n            </div>\r\n            <div class=\"main__header__title__col\">\r\n              <p>{{ 'deposit_cancel_imposition_amount' | translate }}</p>\r\n              <h1>{{ (imposition$ | async).importeNominal | currency }}</h1>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"main__body\">\r\n        <div class=\"main__body__confirm\">\r\n          <span class=\"ico-check-filled\"></span>\r\n          <h2>{{ 'deposit_cancel_impositon_congrats' | translate }}</h2>\r\n          <h2>{{ 'deposit_cancel_impositon_success_operation' | translate }}</h2>\r\n          <p>{{ 'deposit_cancel_impositon_success_money' | translate }}</p>\r\n        </div>\r\n        <button type=\"button\" [routerLink]=\"['..']\" class=\"btn--primary\">\r\n          {{ 'deposit_cancel_impositon_success_button' | translate }}\r\n        </button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n  <div class=\"main__button\">\r\n    <button type=\"button\" [routerLink]=\"['..']\" class=\"btn--primary\">\r\n      {{ 'deposit_cancel_impositon_success_button' | translate }}\r\n    </button>\r\n  </div>\r\n</div>\r\n","<ng-container *ngIf=\"state$ | async as state\">\r\n  <div class=\"max-size deposit-form\">\r\n    <div class=\"main\" *ngIf=\"isPendingSignResponse\">\r\n      <div class=\"main-col\">\r\n        <div class=\"main__header\">\r\n          <div class=\"main__header__desktop\">\r\n            <div class=\"main__header__title\">\r\n              <div class=\"main__header__title__col\">\r\n                <h1>{{ 'deposit_hire_title' | translate }}</h1>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div class=\"main__body\">\r\n          <p class=\"info-text\">{{ 'deposit_hire_loading_sign_response' | translate }}</p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <div\r\n      class=\"main\"\r\n      *ngIf=\"!isPendingSignResponse && canMakeFirstImposition && state.globalPosition\"\r\n    >\r\n      <div class=\"main-col\">\r\n        <div class=\"main__header\">\r\n          <div class=\"main__header__desktop\">\r\n            <div class=\"main__header__title\">\r\n              <div class=\"main__header__title__col\">\r\n                <h1>{{ 'deposit_hire_title' | translate }}</h1>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div class=\"main__body\">\r\n          <app-new-imposition-form\r\n            [account]=\"state?.account\"\r\n            [deposit]=\"state?.deposit\"\r\n            [impositionConditions]=\"impositionConditions$ | async\"\r\n            (makeImposition)=\"onMakeImposition($event)\"\r\n          ></app-new-imposition-form>\r\n        </div>\r\n      </div>\r\n      <div class=\"aside-col\">\r\n        <app-hire-deposit-status-bar [step]=\"2\"></app-hire-deposit-status-bar>\r\n      </div>\r\n    </div>\r\n  </div>\r\n\r\n  <ng-template #otpModal>\r\n    <app-otp-form\r\n      [invalidCode]=\"invalidImpositionOtpCode\"\r\n      (send)=\"createImposition($event)\"\r\n      (repeat)=\"generateOtp()\"\r\n      (hide)=\"closeModal()\"\r\n    ></app-otp-form>\r\n  </ng-template>\r\n</ng-container>\r\n","import { Component, OnInit } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'app-hire-deposit-success',\r\n  templateUrl: './hire-deposit-success.component.html',\r\n  styles: []\r\n})\r\nexport class HireDepositSuccessComponent implements OnInit {\r\n\r\n  constructor() { }\r\n\r\n  ngOnInit(): void {\r\n  }\r\n\r\n}\r\n","import { Component, OnInit, Self, ViewChild, TemplateRef, OnDestroy } from '@angular/core';\r\nimport { ImpositionService } from '@deposit/services/imposition.service';\r\nimport { Imposition, ApiError } from '@api/models';\r\nimport { BsModalService, BsModalRef } from 'ngx-bootstrap/modal';\r\nimport { Router, ActivatedRoute } from '@angular/router';\r\nimport { ErrorHandlerService } from '@core/services/errors/error-handler.service';\r\nimport { isInvalidOtp } from '@core/utils';\r\nimport { retryWhen, mergeMap, delay, map, finalize } from 'rxjs/operators';\r\nimport { of, throwError, Subscription } from 'rxjs';\r\nimport { DepositService } from '@core/services/deposit/deposit.service';\r\n\r\n@Component({\r\n  selector: 'app-first-imposition',\r\n  templateUrl: './first-imposition.component.html',\r\n  styles: [],\r\n  providers: [ImpositionService],\r\n})\r\nexport class FirstImpositionComponent implements OnInit, OnDestroy {\r\n  readonly state$ = this.impositionService.state$;\r\n  readonly impositionConditions$ = this.impositionService.impositionConditions$;\r\n  @ViewChild('otpModal') otpModal: TemplateRef<any>;\r\n\r\n  isPendingSignResponse = true;\r\n  canMakeFirstImposition = false;\r\n\r\n  invalidImpositionOtpCode = false;\r\n  private modalRef: BsModalRef;\r\n  private subs = new Subscription();\r\n\r\n  constructor(\r\n    private modalService: BsModalService,\r\n    private router: Router,\r\n    private route: ActivatedRoute,\r\n    private errorHandler: ErrorHandlerService,\r\n    @Self() private impositionService: ImpositionService,\r\n    private depositService: DepositService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.getRequiredDoc();\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.closeModal();\r\n    this.impositionService.destroy();\r\n    this.subs.unsubscribe();\r\n  }\r\n\r\n  openModal(ref: any) {\r\n    if (!this.modalService.getModalsCount()) {\r\n      this.modalRef = this.modalService.show(ref);\r\n    }\r\n  }\r\n\r\n  closeModal() {\r\n    this.modalRef?.hide();\r\n  }\r\n\r\n  getRequiredDoc() {\r\n    this.subs.add(\r\n      this.depositService\r\n        .getRequiredDoc()\r\n        .pipe(\r\n          map(this.mapInProgressClient),\r\n          retryWithBackoff(),\r\n          finalize(() => {\r\n            this.isPendingSignResponse = false;\r\n          })\r\n        )\r\n        .subscribe(\r\n          () => {\r\n            this.impositionService.fetchGlobalPosition();\r\n            this.canMakeFirstImposition = true;\r\n          },\r\n          (error) => {\r\n            this.errorHandler.showError(error, () => {\r\n              this.router.navigate(['..'], {\r\n                relativeTo: this.route,\r\n              });\r\n            });\r\n          }\r\n        )\r\n    );\r\n  }\r\n\r\n  onMakeImposition(imposition: Imposition) {\r\n    this.impositionService.initImposition(imposition);\r\n    this.generateOtp();\r\n  }\r\n\r\n  generateOtp() {\r\n    this.invalidImpositionOtpCode = false;\r\n\r\n    this.impositionService.generateOtp(\r\n      () => {\r\n        this.openModal(this.otpModal);\r\n      },\r\n      (error) => {\r\n        this.errorHandler.showError(error);\r\n      }\r\n    );\r\n  }\r\n\r\n  createImposition(secretKey: string) {\r\n    this.impositionService.createImposition(\r\n      secretKey,\r\n      () => {\r\n        this.closeModal();\r\n        this.navigateToSuccessPage();\r\n      },\r\n      (error) => {\r\n        if (isInvalidOtp(error)) {\r\n          this.invalidImpositionOtpCode = true;\r\n          return;\r\n        }\r\n        this.closeModal();\r\n        this.errorHandler.showError(error);\r\n      }\r\n    );\r\n  }\r\n\r\n  private mapInProgressClient(response: any) {\r\n    // In progress\r\n    if (response.code === 'OB_GET_REQUIRED_DOC_IN_PROGRESS') {\r\n      const error: ApiError = {\r\n        message: 'OB_GET_REQUIRED_DOC_IN_PROGRESS',\r\n        errorCode: 'OB_GET_REQUIRED_DOC_IN_PROGRESS',\r\n      };\r\n      throw error;\r\n    }\r\n\r\n    // RSI Failed\r\n    if (response.code === 'OB_GET_REQUIRED_DOC_NOT_APPROVED') {\r\n      const error: ApiError = {\r\n        message: 'OB_GET_REQUIRED_DOC_NOT_APPROVED',\r\n        errorCode: 'OB_GET_REQUIRED_DOC_NOT_APPROVED',\r\n      };\r\n      throw error;\r\n    }\r\n\r\n    return response;\r\n  }\r\n\r\n  private navigateToSuccessPage() {\r\n    this.router.navigate(['../hire-deposit-success'], {\r\n      skipLocationChange: true,\r\n      relativeTo: this.route,\r\n    });\r\n  }\r\n}\r\n\r\nexport function retryWithBackoff() {\r\n  let retries = 25;\r\n  const delayTime = 7500;\r\n\r\n  return (src) =>\r\n    src.pipe(\r\n      retryWhen((errors) =>\r\n        errors.pipe(\r\n          mergeMap((error: ApiError) => {\r\n            if (error?.errorCode === 'OB_GET_REQUIRED_DOC_IN_PROGRESS') {\r\n              if (retries-- > 0) {\r\n                return of(error).pipe(delay(delayTime));\r\n              } else {\r\n                return throwError({ errorCode: 'MAX_RETRIES_EXCEEDED' } as ApiError);\r\n              }\r\n            } else {\r\n              retries = 5;\r\n              return throwError(error);\r\n            }\r\n          })\r\n        )\r\n      )\r\n    );\r\n}\r\n","import { Component, OnInit, ChangeDetectionStrategy } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'app-success-new-imposition',\r\n  templateUrl: './success-new-imposition.component.html',\r\n  styles: [],\r\n  changeDetection: ChangeDetectionStrategy.OnPush,\r\n})\r\nexport class SuccessNewImpositionComponent implements OnInit {\r\n  constructor() {}\r\n\r\n  ngOnInit(): void {}\r\n}\r\n","import { Component, OnInit } from '@angular/core';\r\nimport { GlobalPositionService } from '@core/services/global-position/global-position.service';\r\nimport { Router, ActivatedRoute } from '@angular/router';\r\nimport { tap, map } from 'rxjs/operators';\r\nimport { ListaImposicionesCliente } from '@api/models';\r\nimport { Observable, zip } from 'rxjs';\r\nimport { findDeposit } from '@core/utils';\r\n\r\n@Component({\r\n  selector: 'app-success-refund',\r\n  templateUrl: './success-refund.component.html',\r\n  styles: [],\r\n})\r\nexport class SuccessRefundComponent implements OnInit {\r\n  readonly state$ = this.createStateStream();\r\n  readonly imposition$ = this.createImpositionStream();\r\n\r\n  constructor(\r\n    private globalPositionService: GlobalPositionService,\r\n    private activatedRoute: ActivatedRoute,\r\n    private router: Router\r\n  ) {}\r\n\r\n  ngOnInit() {}\r\n\r\n  private createStateStream() {\r\n    return zip(\r\n      this.globalPositionService.globalPosition$,\r\n      this.globalPositionService.globalPosition$.pipe(findDeposit())\r\n    ).pipe(map(([globalPosition, deposit]) => ({ globalPosition, deposit })));\r\n  }\r\n\r\n  private createImpositionStream() {\r\n    return this.activatedRoute.queryParams.pipe(\r\n      tap((imposition: Partial<ListaImposicionesCliente>) => {\r\n        if (isNaN(parseFloat(imposition.importeNominal))) {\r\n          this.router.navigate(['..'], { relativeTo: this.activatedRoute });\r\n        }\r\n      })\r\n    ) as Observable<Partial<ListaImposicionesCliente>>;\r\n  }\r\n}\r\n","import { DepositComponent } from './deposit.component';\r\nimport { NgModule } from '@angular/core';\r\nimport { Routes, RouterModule } from '@angular/router';\r\nimport { NewImpositionComponent } from './pages/new-imposition/new-imposition.component';\r\nimport { HireDepositComponent } from './pages/hire-deposit/hire-deposit.component';\r\nimport { SuccessRefundComponent } from './pages/success-refund/success-refund.component';\r\nimport { SuccessNewImpositionComponent } from './pages/success-new-imposition/success-new-imposition.component';\r\nimport { FirstImpositionComponent } from './pages/first-imposition/first-imposition.component';\r\nimport { HireDepositSuccessComponent } from './pages/hire-deposit-success/hire-deposit-success.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: '',\r\n    component: DepositComponent,\r\n  },\r\n  {\r\n    path: 'new-imposition',\r\n    component: NewImpositionComponent,\r\n  },\r\n  {\r\n    path: 'refund-success',\r\n    component: SuccessRefundComponent,\r\n  },\r\n  {\r\n    path: 'new-imposition-success',\r\n    component: SuccessNewImpositionComponent,\r\n  },\r\n  {\r\n    path: 'hire',\r\n    component: HireDepositComponent,\r\n  },\r\n  {\r\n    path: 'first-imposition',\r\n    component: FirstImpositionComponent,\r\n  },\r\n  {\r\n    path: 'hire-deposit-success',\r\n    component: HireDepositSuccessComponent,\r\n  },\r\n];\r\n\r\n@NgModule({\r\n  imports: [RouterModule.forChild(routes)],\r\n  exports: [RouterModule],\r\n})\r\nexport class DepositRoutingModule {}\r\n","<div class=\"max-size deposit\">\r\n  <div class=\"main\">\r\n    <div class=\"main-col no-aside\">\r\n      <div class=\"main__header\">\r\n        <div class=\"main__header__desktop\">\r\n          <div class=\"main__header__title\">\r\n            <div class=\"main__header__title__col\">\r\n              <h1>{{ 'deposit_new_imposition_title' | translate }}</h1>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"main__body\">\r\n        <div class=\"main__body__confirm\">\r\n          <span class=\"ico-check-filled\"></span>\r\n          <h2>{{ 'deposit_new_impositon_congrats' | translate }}</h2>\r\n          <h2>{{ 'deposit_new_impositon_success_process' | translate }}</h2>\r\n          <p>{{ 'deposit_new_impositon_success_balance' | translate }}</p>\r\n        </div>\r\n        <button type=\"button\" [routerLink]=\"['..']\" class=\"btn--primary\">\r\n          {{ 'deposit_new_impositon_success_button' | translate }}\r\n        </button>\r\n        <div class=\"main__button\">\r\n          <button type=\"button\" [routerLink]=\"['..']\" class=\"btn--primary\">\r\n            {{ 'deposit_new_impositon_success_button' | translate }}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</div>\r\n","<div class=\"max-size deposit deposit-form\">\r\n  <div class=\"main\">\r\n    <div class=\"main-col\">\r\n      <div class=\"main__header\">\r\n        <div class=\"main__header__desktop\">\r\n          <div class=\"main__header__title\">\r\n            <div class=\"main__header__title__col\">\r\n              <h1>{{ 'deposit_hire_title' | translate }}</h1>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"main__body\">\r\n        <div class=\"main__body__confirm\">\r\n          <span class=\"ico-check-filled\"></span>\r\n          <h2>{{ 'deposit_hire_congrats' | translate }}</h2>\r\n          <h2>{{ 'deposit_hire_process_success' | translate }}</h2>\r\n          <p>{{ 'deposit_hire_deposit_ready_caption' | translate }}</p>\r\n        </div>\r\n        <button type=\"button\" [routerLink]=\"['..']\" class=\"btn--primary\">\r\n          {{ 'deposit_hire_button_understand' | translate }}\r\n        </button>\r\n        <div class=\"main__button\">\r\n          <button type=\"button\" [routerLink]=\"['..']\" class=\"btn--primary\">\r\n            {{ 'deposit_hire_button_understand' | translate }}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    <div class=\"aside-col\">\r\n      <app-hire-deposit-status-bar [step]=\"3\"></app-hire-deposit-status-bar>\r\n    </div>\r\n  </div>\r\n</div>\r\n","import { NgModule } from '@angular/core';\r\n\r\nimport { DepositRoutingModule } from './deposit-routing.module';\r\nimport { NewImpositionComponent } from './pages/new-imposition/new-imposition.component';\r\nimport { SharedModule } from '@shared/shared.module';\r\nimport { DepositComponent } from './deposit.component';\r\nimport { HireDepositComponent } from './pages/hire-deposit/hire-deposit.component';\r\nimport { ImpositionItemComponent } from './components/imposition-item/imposition-item.component';\r\nimport { SuccessRefundComponent } from './pages/success-refund/success-refund.component';\r\nimport { NewImpositionFormComponent } from './components/new-imposition-form/new-imposition-form.component';\r\nimport { SuccessNewImpositionComponent } from './pages/success-new-imposition/success-new-imposition.component';\r\nimport { FirstImpositionComponent } from './pages/first-imposition/first-imposition.component';\r\nimport { HireDepositFormComponent } from './components/hire-deposit-form/hire-deposit-form.component';\r\nimport { HireDepositStatusBarComponent } from './components/hire-deposit-status-bar/hire-deposit-status-bar.component';\r\nimport { HireDepositSuccessComponent } from './pages/hire-deposit-success/hire-deposit-success.component';\r\n\r\n@NgModule({\r\n  declarations: [\r\n    DepositComponent,\r\n    NewImpositionComponent,\r\n    HireDepositComponent,\r\n    ImpositionItemComponent,\r\n    SuccessRefundComponent,\r\n    NewImpositionFormComponent,\r\n    SuccessNewImpositionComponent,\r\n    FirstImpositionComponent,\r\n    HireDepositFormComponent,\r\n    HireDepositStatusBarComponent,\r\n    HireDepositSuccessComponent,\r\n  ],\r\n  imports: [SharedModule, DepositRoutingModule],\r\n})\r\nexport class DepositModule {}\r\n"]}